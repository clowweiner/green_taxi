<!DOCTYPE html>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-hexbin.v0.2.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="//d3js.org/d3-tile.v0.0.min.js"></script>
<script>

  const width = 1600;
  const height = 800;


  const svg = d3.select('body').append('svg')
	.attr('width', width)
	.attr('height', height);
  
  var projection = d3.geoMercator()
      .center([-73.95, 40.7])
      .scale(80000)
      .translate([(width) / 3, (height)/2]);

  var path = d3.geoPath()
      .projection(projection);

  function clickHex(d) {
      proj = path.centroid(d);

      xc = projection.invert(proj)[0]
      yc = projection.invert(proj)[1]
      
      var projectionZoom = d3.geoMercator()
	  .center([xc,yc])
	  .scale(80000)
	  .translate([1200,(height)/2]);

      var pathZoom = d3.geoPath()
	  .projection(projectionZoom);

      var node = d3.select(this).node(),
	  xOff = 1200-proj[0],
	  yOff = 400-proj[1],
	  zoom = 40,
	  x = 1200*(zoom-1),
	  y = 400*(zoom-1);

      d3.select(node.parentNode.appendChild(node.cloneNode(true)))
			.attr("fill","white")
			.attr("stroke","black")
			.transition()
			.duration(5000)
			.attr("transform", "translate(" +
			      xOff + "," + yOff + ")").remove();

      var pi = Math.PI,
	  tau = 2 * pi;

      var projectionNew = d3.geoMercator()
	  .scale(1/tau)
	  .translate([0, 0]);

      var pathNew = d3.geoPath()
	  .projection(projectionNew);
           
      var min0 = 0,
	  max0 = -100,
	  min1 = 100,
	  max1 = 0;

      d.geometry.coordinates[0][0].forEach(function(d) {
	  if (d[0] < min0) {	      
	      min0 = d[0]
	  }
	  if (d[1] < min1) {
	      min1 = d[1]
	  }
	  if (d[0] > max0) {
	      max0 = d[0]
	  }
	  if (d[1] > max1) {
	      max1 = d[1]
	  }
      });
      
      var bounds = [[min0,min1],[max0,max1]]
      p0 = projectionNew([bounds[0][0], bounds[1][1]]),
      p1 = projectionNew([bounds[1][0], bounds[0][1]]);      
      
      var k = floor(0.95 / Math.max((p1[0] - p0[0]) / width, (p1[1] - p0[1]) / height)),
	  tx = (width - k * (p1[0] + p0[0])) / 2,
	  ty = (height - k * (p1[1] + p0[1])) / 2;
      
      projectionNew
      	  .scale(k / tau)
      	  .translate([tx, ty]);

      var w = projectionNew([max0,max1])[0]-projectionNew([min0,max1])[0],
	  h = projectionNew([min0,min1])[0]-projectionNew([min0,max1])[1];

      var defs = svg.append('defs')

      svg.select(".zoom").remove();

      console.log(pathNew);
      
      defs.append("path")
	  .attr("id","frame")
      	  .datum(d)
      	  .attr("d", pathNew)
//          .attr("class", "zoom")
      	  .attr("fill", "none")
      	  // .transition()
      	  // .delay(5000)
      	  // .attr("stroke", "black")
      	  // .transition()
      	  // .duration(5000)
      	  .attr("transform", "translate(" + (1200-(width/2)) + "," + 0 + ")");

      defs.append("clipPath")
      	  .attr("id", "hex-clip")
	  .append("use")
	  .attr("xlink:href", "#frame");
      
      var tiles = d3.tile()
	  .size([width, height])
	  .scale(k)
	  .translate([tx, ty])
      ();

      svg.select(".tile").remove();

      svg.append("g")
          .attr("class", "tile")
	  .attr("clip-path", "url(#hex-clip)")
	  .selectAll("image")
      	  .data(tiles).enter()
      	  .append("image")
      	  //.style("position", "absolute")
	  .attr("xlink:href", function(d) { return "http://" + "abc"[d[1] % 3] + ".tile.openstreetmap.org/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
	  .attr("x", function(d) { return (d[0] + tiles.translate[0]) * tiles.scale; })
	  .attr("y", function(d) { return (d[1] + tiles.translate[1]) * tiles.scale; })
	  .attr("width", tiles.scale)
	  .attr("height", tiles.scale)
	  .attr("transform", "translate("+(1200-(width/2))+","+0+")");

      svg.append("use")
	  .attr("xlink:href", "#frame")
	  .attr("class", "stroke");

  }

  function floor(k) {
      return Math.pow(2, Math.floor(Math.log(k) / Math.LN2));
  }

  d3.json("hexGrid.GeoJSON", function(error, hex) {//hexColors.GeoJSON
       var hexes = svg.selectAll("path")
    	  .data(hex.features)
    	  .enter().append("path")
   	  .on("click", clickHex)
    	  .attr("class", "hex")
           .attr("d", path)
   	   .attr("fill", function(d) { return d.properties.color; });//col1
   	  // .transition()
   	  // .on("start", function repeat() {
          //     d3.active(this)
	  // 	  .transition().duration(1000)
   	  // 	  .attr("fill", function(d) { return d.properties.col1; })
   	  // 	  .transition().duration(1000)
   	  // 	  .attr("fill", function(d) { return d.properties.col2; })
   	  // 	  .transition().duration(1000)
   	  // 	  .attr("fill", function(d) { return d.properties.col3; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col4; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col5; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col6; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col7; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col8; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col9; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col10; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col11; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col12; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col13; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col14; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col15; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col16; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col17; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col18; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col19; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col20; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col21; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col22; })
   	  // 	  .transition().duration(1000)
   	  //     	  .attr("fill", function(d) { return d.properties.col23; })
   	  // 	  .transition().duration(1000)
   	  // 	  .attr("fill", function(d) { return d.properties.col24; })
   	  // 	  .on("start", repeat);
   	  // });
  });
</script>
</body>
